# WB_L0

Полное руководство по проекту

Это репозиторий демонстрационного сервиса на Go с минимально необходимой инфраструктурой для продюсера и сервиса заказов, использующий PostgreSQL, in-memory кэш и брокер сообщений.

## Содержание

- О проекте
- Структура репозитория
- Используемые технологии
- Архитектура и ответственность модулей
- Конфигурация и запуск
- Развёртывание через Docker Compose
- Пример использования
- Миграции БД
- Разработка и тестирование
- Дорожная карта и улучшения
- Security и эксплуатация

## О проекте

WB_L0 — демонстрационный backend-сервис, разбитый на несколько команд и пакетов, показывающий подход к организации сервисов на Go: отдельные бинарники для продюсера (`cmd/producer`) и сервиса заказов (`cmd/orderservice`), внутренняя бизнес-логика в `internal/usecase`, модели в `model`, абстракции для доступа к данным в `internal/infrastructure/repo`, соединения с внешними системами в `internal/infrastructure/connectors`, кеш в `internal/infrastructure/cache` и тестовые/утилитные генераторы в `pkg/generator`.

## Структура репозитория

Корневая структура (важные директории и файлы):

- `cmd/` — точка входа для запуска отдельных сервисов
  - `producer/main.go` — бинарь, отвечающий за публикацию сообщений (пример продюсера)
  - `orderservice/main.go` — сервис обработки заказов
- `config/` — конфигурация приложения (`config.go`)
- `internal/` — приватные пакеты сервиса (не экспортируются вовне)
  - `broker/` — реализация консьюмера/подписчика
  - `infrastructure/`
    - `cache/` — абстракция кэша
    - `connectors/` — коннекторы, например к PostgreSQL (`postgres.go`)
    - `repo/` — слой репозитория для работы с БД
  - `usecase/` — бизнес-логика приложения
- `model/` — модели данных (структуры, DTO)
- `pkg/` — вспомогательные, переиспользуемые пакеты
  - `generator/` — утилита/генератор данных
- `migrations/` — SQL миграции БД
- `Makefile`, `docker-compose.yaml` — автозапуск и помощь с локальным стеком

## Используемые технологии

- Язык: Go (модули через `go.mod`)
- СУБД: PostgreSQL (миграции в `migrations/`)
- Кэш: абстракция в `internal/infrastructure/cache`
- Контейнеризация: Docker + Docker Compose (`docker-compose.yaml`)
- Механизм миграций: SQL файлы в `migrations/`
- Внешняя коммуникация: внутренняя брокерная абстракция (в `internal/broker`) — можно подключить NATS / Kafka / RabbitMQ

## Архитектура и ответственность модулей

Архитектурно проект следует принципам чистой архитектуры (слои):

- Модели (`model/`) — простые структуры данных и DTO без логики.
- Репозиторий (`internal/infrastructure/repo`) — взаимодействие с БД, SQL-запросы, маппинг.
- Инфраструктура (`internal/infrastructure/*`) — все внешние зависимости: постгрес-коннекторы, кеш и пр.
- Бизнес-логика (`internal/usecase`) — координирует репозитории и инфраструктуру, реализует правила предметной области.
- Входные точки (`cmd/*`) — билдятся в исполняемые бинарники, настраивают конфигурацию, логирование и привязывают слои вместе.

## Конфигурация

Конфигурация централизована в `config/config.go`.

## Запуск локально (Docker Compose)

Проект включает `docker-compose.yaml`, который облегчает поднимание PostgreSQL.

Стандартные шаги:

1) Поднимите инфраструктуру:

```bash
make up
```

2) Выполните миграции (локально или в контейнере). Рекомендуется использовать `migrate`:

```bash
make migrate-up
```

3) Соберите и запустите сервисы:

```bash
go build ./...
# Запустить конкретный сервис
./bin/order_service   # если вы компилируете в bin/
go run ./cmd/order_service
go run ./cmd/producer
```

Или запустить контейнеры вашего приложения через Docker (при наличии Dockerfile для каждого сервиса).

## Пример использования

- Producer: демонстрирует, как публиковать сообщение в брокер (см. `cmd/producer/main.go`).
- Order Service: слушает события/запросы, работает с репозиторием и кэшем, обрабатывает заказы (см. `cmd/order_service/main.go`).

Пример запроса к сервису заказов (предположим, что он запускает HTTP API на порт 8080):

```bash
curl -X POST http://localhost:8080/orders -d '{"user_id":123, "items":[{"sku":"ABC","qty":1}]}' -H 'Content-Type: application/json'
```

## Миграции БД

Миграции хранятся в `migrations/` и представлены SQL-файлами (например, `20250923162233_init.sql`). Для применения миграций используйте инструмент миграций (например, `goose`).

Рекомендации:
- Храните версии миграций под контролем версий
- Пишите обратимые миграции (UP/DOWN)


## Разработка и тестирование

- Юнит-тесты: `go test ./... -v`
- Интеграционные тесты можно запускать с `docker compose up` (Postgres).

## Дорожная карта и улучшения

- Документация API (OpenAPI / Swagger)
- Добавить контейнерные образы и GitHub Actions для CI/CD
- Полноценный брокер сообщений (Kafka/NATS) и очереди задач
- Метрики и трассировка (Prometheus, OpenTelemetry)
- Подробные интеграционные тесты и тестовые фикстуры

## Security и эксплуатация

- Не хранить пароли и секреты в коде; использовать секретный менеджер или переменные окружения
- Использовать TLS для внешних соединений
- Ограничивать доступ к БД и кэшу через сети Docker/VPC
