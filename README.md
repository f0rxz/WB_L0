# WB_L0

Полное руководство по проекту

Это репозиторий демонстрационного сервиса на Go с минимально необходимой инфраструктурой для продюсера и сервиса заказов, использующий PostgreSQL, in-memory кэш и брокер сообщений.

## Содержание

- О проекте
- Структура репозитория
- Используемые технологии
- Архитектура и ответственность модулей
- Конфигурация и запуск
- Развёртывание через Docker Compose
- Миграции БД
- Разработка и тестирование
- Полезные команды Makefile
- Дорожная карта и улучшения
- Контакты

## О проекте

WB_L0 — демонстрационный backend-сервис, разбитый на несколько команд и пакетов, показывающий подход к организации сервисов на Go: отдельные бинарники для продюсера (`cmd/producer`) и сервиса заказов (`cmd/order_service`), внутренняя бизнес-логика в `internal/usecase`, модели в `model`, абстракции для доступа к данным в `internal/infrastructure/repo`, соединения с внешними системами в `internal/infrastructure/connectors`, кеш в `internal/infrastructure/cache` и тестовые/утилитные генераторы в `pkg/generator`.

## Структура репозитория

Корневая структура (важные директории и файлы):

- `cmd/` — точка входа для запуска отдельных сервисов
  - `producer/main.go` — бинарь, отвечающий за публикацию сообщений (пример продюсера)
  - `order_service/main.go` — сервис обработки заказов
- `internal/` — приватные пакеты сервиса (не экспортируются вовне)
  - `broker/` — реализация консьюмера/подписчика
  - `config/` — конфигурация приложения (`config.go`)
  - `infrastructure/`
    - `cache/` — абстракция кэша
    - `connectors/` — коннекторы, например к PostgreSQL (`postgres.go`)
    - `repo/` — слой репозитория для работы с БД
  - `usecase/` — бизнес-логика приложения
- `model/` — модели данных (структуры, DTO)
- `pkg/` — вспомогательные, переиспользуемые пакеты
  - `generator/` — утилита/генератор данных
- `migrations/` — SQL миграции БД
- `Makefile`, `docker-compose.yaml` — автозапуск и помощь с локальным стеком

## Используемые технологии

- Язык: Go (модули через `go.mod`)
- СУБД: PostgreSQL (миграции в `migrations/`)
- Кэш: абстракция в `internal/infrastructure/cache`
- Контейнеризация: Docker + Docker Compose (`docker-compose.yaml`)
- Механизм миграций: SQL файлы в `migrations/` (можно использовать `golang-migrate` или `migrate`)
- Внешняя коммуникация: внутренняя брокерная абстракция (в `internal/broker`) — можно подключить NATS / Kafka / RabbitMQ

## Архитектура и ответственность модулей

Архитектурно проект следует принципам чистой архитектуры (слои):

- Модели (`model/`) — простые структуры данных и DTO без логики.
- Репозиторий (`internal/infrastructure/repo`) — взаимодействие с БД, SQL-запросы, маппинг.
- Инфраструктура (`internal/infrastructure/*`) — все внешние зависимости: постгрес-коннекторы, кеш и пр.
- Бизнес-логика (`internal/usecase`) — координирует репозитории и инфраструктуру, реализует правила предметной области.
- Входные точки (`cmd/*`) — билдятся в исполняемые бинарники, настраивают конфигурацию, логирование и привязывают слои вместе.

Такой раздельный подход упрощает тестирование и заменяемость компонентов.

## Конфигурация

Конфигурация централизована в `internal/config/config.go`.

## Запуск локально (Docker Compose)

Проект включает `docker-compose.yaml`, который облегчает поднимание PostgreSQL.

Стандартные шаги:

1) Поднимите инфраструктуру:

```bash
docker compose up -d
```

2) Выполните миграции (локально или в контейнере). Рекомендуется использовать `migrate`:

```bash
# Пример с использованием golang-migrate (нужно установить):
migrate -path ./migrations -database "postgres://user:pass@localhost:5432/dbname?sslmode=disable" up
```

3) Соберите и запустите сервисы:

```bash
go build ./...
# Запустить конкретный сервис
./bin/order_service   # если вы компилируете в bin/
go run ./cmd/order_service
go run ./cmd/producer
```

Или запустить контейнеры вашего приложения через Docker (при наличии Dockerfile для каждого сервиса).

## Пример использования

- Producer: демонстрирует, как публиковать сообщение в брокер (см. `cmd/producer/main.go`).
- Order Service: слушает события/запросы, работает с репозиторием и кэшем, обрабатывает заказы (см. `cmd/order_service/main.go`).

Пример запроса к сервису заказов (предположим, что он запускает HTTP API на порт 8080):

```bash
curl -X POST http://localhost:8080/orders -d '{"user_id":123, "items":[{"sku":"ABC","qty":1}]}' -H 'Content-Type: application/json'
```

Адаптируйте URL и payload под реальную реализацию в `cmd/order_service`.

## Миграции БД

Миграции хранятся в `migrations/` и представлены SQL-файлами (например, `20250923162233_init.sql`). Для применения миграций используйте инструмент миграций (например, `golang-migrate/migrate`).

Рекомендации:
- Храните версии миграций под контролем версий
- Пишите обратимые миграции (UP/DOWN)

## Разработка и тестирование

- Код разбит по пакетам, используйте модульный подход: тесты для usecase и repo отдельно.
- Для unit-тестов в Go используйте `testing` и фейковые/моковые реализации интерфейсов. Можно использовать `testify` для ассертoв и моков.
- Интеграционные тесты можно запускать в Docker Compose с поднятыми PostgreSQL и Redis.

Пример запуска тестов:

```bash
go test ./... -v
```

## Полезные команды (Makefile)

В `Makefile` обычно можно найти правила для: сборки, запуска, тестирования и линтинга. Примеры:

- make build — собрать бинарники
- make run — запустить сервис локально
- make up — запустить docker compose
- make migrate — применить миграции

Проверьте `Makefile` в корне проекта для конкретных команд.

## Качество кода и CI

Рекомендации по CI:

- Запуск `go vet`, `golangci-lint` и `go test ./...`
- Проверка форматирования `gofmt` или `go fmt`
- Прогон миграций и базовых интеграционных тестов в отдельном job

## Дорожная карта и улучшения

- Документация API (OpenAPI / Swagger)
- Добавить контейнерные образы и GitHub Actions для CI/CD
- Полноценный брокер сообщений (Kafka/NATS) и очереди задач
- Метрики и трассировка (Prometheus, OpenTelemetry)
- Подробные интеграционные тесты и тестовые фикстуры

## Security и эксплуатация

- Не хранить пароли и секреты в коде; использовать секретный менеджер или переменные окружения
- Использовать TLS для внешних соединений
- Ограничивать доступ к БД и кэшу через сети Docker/VPC
