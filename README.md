# WB_L0

Это репозиторий демонстрационного сервиса на Go: сервис заказов (`cmd/orderservice`) и вспомогательный продюсер (`cmd/producer`). Проект показывает упрощённую, но практичную архитектуру с DI, HTTP/Kafka контроллерами, репозиторием, in-memory кэшем и тестовой инфраструктурой.

## Быстрая структура проекта

В проекте важны следующие директории и файлы:

- `cmd/` — точки входа для сервисов
  - `orderservice/` — основной сервис обработки заказов
  - `producer/` — пример продюсера сообщений
- `config/` — загрузка конфигурации
- `internal/` — приватные пакеты сервиса
  - `controller/`
    - `http/` — HTTP-роутер и сервер (routes + server lifecycle)
    - `kafkacontroller/` — слой, который управляет потреблением сообщений из Kafka и делегирует обработку в usecase
  - `di/` — простая реализация dependency injection, собирает контейнер сервисов
  - `infrastructure/`
    - `cache/` — in-memory cache + cleaner
    - `repo/` — слой доступа к БД (Postgres via pgx)
  - `usecase/` — бизнес-логика (инварианты, валидация)
- `model/` — структуры данных (Order и вложенные сущности)
- `mocks/` — сгенерированные gomock-моки (используются в тестах)
- `pkg/` — вспомогательные пакеты (например, коннекторы/генераторы)
- `migrations/` — SQL миграции для БД

## Ключевые идеи и паттерны

- Чёткое разделение слоёв: controller → usecase → infrastructure (repo/cache).
- Dependency Injection: `internal/di` собирает зависимости (DB pool, repo, cache, usecase, controllers) и возвращает контейнер.
- Контроллеры:
  - HTTP controller предоставляет маршруты и Server-интерфейс (Start/Shutdown).
  - Kafka controller управляет консьюмером и обрабатывает входящие сообщения через usecase.
- Логирование: использован `go.uber.org/zap`; приложение выставляет глобальный логгер, а HTTP handlers прикрепляют request-scoped логгер с `request_id` в контекст для трассировки.
- Валидация: в `model` добавлена валидация полей (например, `DateCreated`) и используется в ходе создания заказа.

## Конфигурация

Конфигурация загружается из `config/config.go` (через env-конфигурацию). Основные переменные:

- HTTP порт
- POSTGRES_DSN (DSN для Postgres)
- Kafka настройки (если используются)

## Запуск локально

1) Поднять Postgres (локально или через docker-compose):

```bash
make up
```

2) Выполнить миграции (при необходимости):

```bash
make migrate-up
```

3) Сборка и запуск сервиса (локально):

```bash
go build ./...
# Запустить orderservice
go run ./cmd/orderservice
# Запустить producer (пример сообщения)
go run ./cmd/producer
```

## Тестирование

- Запустить все unit-тесты:

```bash
go test ./... -v
```

## Безопасность

Ниже — краткие рекомендации по безопасности, применимые к этому сервису:

- Секреты не должны храниться в репозитории. Используйте переменные окружения, секретные менеджеры (Vault, AWS Secrets Manager) или Kubernetes Secrets.
- Никогда не логируйте чувствительные данные (пароли, токены, секреты, полные номера карт). Настройте redaction/маскирование в логгере при необходимости.
- TLS: включите TLS для всех внешних соединений (HTTP, DB, брокер сообщений). Для локальной разработки используйте самоподписанные сертификаты или прокси.
- Соединения с БД: используйте безопасные DSN с TLS/sslmode и ограничьте доступ по сети (VPC, firewalls). Применяйте принцип минимальных привилегий в учетных записях БД.
- Валидация входных данных: валидируйте и нормализуйте входящие поля (например, `DateCreated`) в границе приложения, чтобы избежать логических ошибок и атак.
- Защита от SQL-инъекций: используйте подготовленные выражения и pgx параметризованные запросы (как в `internal/infrastructure/repo`). Не конкатенируйте параметры в SQL.
- Аутентификация и авторизация: если сервис будет публичным, добавьте слой аутентификации и проверку прав доступа для критичных операций.
- Обновления зависимостей: регулярно проверяйте и обновляйте зависимости (vulnerabilities scan, `go list -u -m all`, Dependabot/GitHub security alerts).
- Работа в продуктиве: запускайте сервис под непривилегированным пользователем, ограничивайте сетевые порты и используйте системы мониторинга/alerting.

